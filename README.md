# Context Pruner - –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –ø—É—Ç–µ–º —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≤–∫–ª–∏–¥–æ–≤–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É embeddings.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `env.example` –≤ `.env` –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
```bash
# Windows PowerShell:
Copy-Item env.example .env

# Linux/Mac:
cp env.example .env
```

3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env` —Ñ–∞–π–ª (—Å–º. –ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü—Ä–∏–º–µ—Ä `.env`:

```env
E1=0.75
E2=15
EMB_URL=http://localhost:11434
EMB_MODEL=ollama/nomic-embed-text
BATCH_SIZE=64
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ollama –¥–ª—è embeddings

–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π embedding-—Å–µ—Ä–≤–∏—Å. –ü—Ä–∏–º–µ—Ä `docker-compose.yml` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Ollama:

```yaml
version: '3.8'

services:
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0

volumes:
  ollama_data:
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `docker-compose up -d`, –∑–∞–≥—Ä—É–∑–∏—Ç–µ embedding-–º–æ–¥–µ–ª—å:
```bash
docker exec -it <container_name> ollama pull nomic-embed-text
```

**–í–∞–∂–Ω–æ**: –ï—Å–ª–∏ –≤–∞—à embedding API –∏–º–µ–µ—Ç –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `embeddings.py`, –º–µ—Ç–æ–¥ `_get_embeddings_batch`. –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `openai`. –î–ª—è Ollama –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä—è–º–æ–π HTTP-–∑–∞–ø—Ä–æ—Å –∫ `/api/embeddings`.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫:

```bash
python main.py context.txt query.txt
```

### –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º —Ä–∞—Å—á–µ—Ç–æ–≤:

```bash
python main.py context.txt query.txt -v
```

–ü–∞—Ä–∞–º–µ—Ç—Ä `-v` (–∏–ª–∏ `--verbose`) –≤—ã–≤–æ–¥–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã –¥–ª—è —ç—Ç–∞–ø–æ–≤ 1 –∏ 2:
- –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ú–∞—Ç—Ä–∏—Ü—É —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –º–µ–∂–¥—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
- –ì—Ä—É–ø–ø—ã –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ –≤—ã–±–æ—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ —ç—Ç–∞–ø–µ 2

### –° —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:

```bash
python main.py context.txt query.txt --keep-original-if-empty
```

### –ü—Ä–∏–º–µ—Ä —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

```bash
python main.py tests/fixtures/context_sample.txt tests/fixtures/query_sample.txt
```

## –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞

### –í–∏–∑—É–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª:

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∏—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å —Ü–≤–µ—Ç–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π:
- üü¢ **KEPT** (–∑–µ–ª–µ–Ω—ã–π) - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- üî¥ **REMOVED_STAGE_1** (–∫—Ä–∞—Å–Ω—ã–π) - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∫–∞–∫ –¥—É–±–ª–∏–∫–∞—Ç—ã
- üü° **REMOVED_STAGE_2** (–∂–µ–ª—Ç—ã–π) - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∫–∞–∫ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ

–ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–æ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º:
```
[0] [KEPT] –≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
[1] [REMOVED_STAGE_1] –≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∫–∞–∫ –¥—É–±–ª–∏–∫–∞—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è [0].
[2] [REMOVED_STAGE_2] –≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∫–∞–∫ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ –∑–∞–ø—Ä–æ—Å—É.
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:

–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è –∫—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
```
–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: 100 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
–£–¥–∞–ª–µ–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ 1 (–¥—É–±–ª–∏–∫–∞—Ç—ã): 15 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
–£–¥–∞–ª–µ–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ 2 (–Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ): 30 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
–û—Å—Ç–∞–ª–æ—Å—å –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ: 55 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
```

### –§–∞–π–ª–æ–≤—ã–π –≤—ã–≤–æ–¥:

–£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ stdout –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ñ–∞–π–ª:
```bash
python main.py context.txt query.txt > reduced_context.txt
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

- **E1** - –ü–æ—Ä–æ–≥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ < E1, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å—á–∏—Ç–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏.
- **E2** - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞ 2. –û—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º –¥–æ –∑–∞–ø—Ä–æ—Å–∞. –ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞ 1 –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –≤—Å–µ –æ—Å—Ç–∞—é—Ç—Å—è.
- **EMB_URL** - URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –¥–ª—è embedding –º–æ–¥–µ–ª–∏
- **EMB_MODEL** - –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è embeddings
- **BATCH_SIZE** - –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è embeddings

## –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

1. **–†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è**: –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö —Ä—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫–∏.

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ embeddings**: –î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—É—á–∞—é—Ç—Å—è embeddings —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π embedding-—Å–µ—Ä–≤–∏—Å (Ollama).

3. **–≠—Ç–∞–ø 1 - –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**:
   - –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –º–∞—Ç—Ä–∏—Ü–∞ –µ–≤–∫–ª–∏–¥–æ–≤—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –º–µ–∂–¥—É –≤—Å–µ–º–∏ –ø–∞—Ä–∞–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
   - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º < E1 –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ –ø–æ—Ö–æ–∂–∏–µ
   - –í –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - —Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –±–ª–∏–∂–µ –≤—Å–µ–≥–æ –∫ –∑–∞–ø—Ä–æ—Å—É

4. **–≠—Ç–∞–ø 2 - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏**:
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –µ–≤–∫–ª–∏–¥–æ–≤–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∑–∞–ø—Ä–æ—Å–∞
   - –û—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ E2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º –¥–æ –∑–∞–ø—Ä–æ—Å–∞
   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞ 1 –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ E2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –≤—Å–µ –æ—Å—Ç–∞—é—Ç—Å—è

5. **–í—ã–≤–æ–¥**: –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ —Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
python -m pytest tests/
```

–ò–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç:
```bash
python -m pytest tests/test_utils.py
python -m pytest tests/test_prune.py
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Å–ª—É—á–∞–∏:
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `.env` —Ñ–∞–π–ª–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è E1/E2 (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å >= 0)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ embedding API
- –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Å –æ–ø—Ü–∏–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —è–∑—ã–∫–æ–≤

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫–∏. –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–æ—á–∫–∞–º–∏, –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∑–Ω–∞–∫–∞–º–∏, –∞ —Ç–∞–∫–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫.

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

#   c o n t e x t - s i z e r  
 